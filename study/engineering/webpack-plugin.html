<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>「webpack 核心特性」插件(plugin) | Yanxu Gong's Blog</title>
    <meta name="description" content="Personal blog based on Github Action + VitePress">
    <link rel="stylesheet" href="/blog-next/assets/style.88a1b92e.css">
    <link rel="modulepreload" href="/blog-next/assets/chunks/AlgoliaSearchBox.dd75b3aa.js">
    <link rel="modulepreload" href="/blog-next/assets/app.acdedced.js">
    <link rel="modulepreload" href="/blog-next/assets/study_engineering_webpack-plugin.md.b64db039.lean.js">
    
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <meta name="twitter:title" content="「webpack 核心特性」插件(plugin) | Yanxu Gong&#39;s Blog">
  <meta property="og:title" content="「webpack 核心特性」插件(plugin) | Yanxu Gong&#39;s Blog">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-95cd145e><div class="sidebar-button" data-v-95cd145e><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/blog-next/" aria-label="Yanxu Gong&#39;s Blog, back to home" data-v-95cd145e data-v-2627e0f1><img class="logo" src="/blog-next/logo.svg" alt="Logo" data-v-2627e0f1> Yanxu Gong&#39;s Blog</a><div class="flex-grow" data-v-95cd145e></div><div class="nav" data-v-95cd145e><nav class="nav-links" data-v-95cd145e data-v-b68e4bf6><!--[--><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item active" href="/blog-next/study/" data-v-43e5dab6>学习 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/photography/" data-v-43e5dab6>摄影 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/emotion/" data-v-43e5dab6>情感 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/about/" data-v-43e5dab6>关于 <!----></a></div></div><!--]--><!----><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item isExternal" href="https://github.com/yanxugong/blog-next" target="_blank" rel="noopener noreferrer" data-v-43e5dab6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-43e5dab6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-1c2cc348><nav class="nav-links nav" data-v-1c2cc348 data-v-b68e4bf6><!--[--><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item active" href="/blog-next/study/" data-v-43e5dab6>学习 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/photography/" data-v-43e5dab6>摄影 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/emotion/" data-v-43e5dab6>情感 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/about/" data-v-43e5dab6>关于 <!----></a></div></div><!--]--><!----><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item isExternal" href="https://github.com/yanxugong/blog-next" target="_blank" rel="noopener noreferrer" data-v-43e5dab6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-43e5dab6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-1c2cc348><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#前言">前言</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#plugin-相对于-loader-有哪些区别？">plugin 相对于 loader 有哪些区别？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#plugin-该怎么配置呢？">plugin 该怎么配置呢？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#有哪些常见的-plugin？">有哪些常见的 plugin？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#怎么写一个-plugin？">怎么写一个 plugin？</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#tapable">tapable</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#compiler">compiler</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#compilation">compilation</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#热身">热身</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#实战">实战</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#拓展">拓展</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#系列文章">系列文章</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#感谢">感谢</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-3d00e640><div class="container" data-v-3d00e640><!--[--><!--]--><div style="position:relative;" class="content" data-v-3d00e640><div><h1 id="「webpack-核心特性」插件-plugin" tabindex="-1">「webpack 核心特性」插件(plugin) <a class="header-anchor" href="#「webpack-核心特性」插件-plugin" aria-hidden="true">#</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-hidden="true">#</a></h2><p>大家有没有遇到过这些问题：</p><ul><li>webpack 打包之后的文件没有压缩</li><li>静态文件要手动拷贝到输出目录</li><li>代码中写了很多环境判断的多余代码</li></ul><p>上一篇 <a href="https://juejin.cn/post/6916315177411411981" target="_blank" rel="noopener noreferrer">「webpack 核心特性」loader</a> 说到 webpack 的 <code>loader</code> 机制，本文主要聊一聊另外一个核心特性：插件(<code>plugin</code>)。</p><p>插件机制就是为了完成项目中除了资源模块打包以外的其他自动化工作，解决上述的问题。</p><p><code>plugin</code> 是用来扩展 webpack 功能的，通过在构建流程里注入钩子实现，它为 webpack 带来了很大的灵活性。</p><h2 id="plugin-相对于-loader-有哪些区别？" tabindex="-1">plugin 相对于 loader 有哪些区别？ <a class="header-anchor" href="#plugin-相对于-loader-有哪些区别？" aria-hidden="true">#</a></h2><p><code>loader</code> 是转换器，将一种文件编译转换为另一个文件，操作的是文件。例如：将 <code>.less</code> 文件转换成 <code>.css</code> 文件。</p><p><code>plugin</code> 是扩展器，它是针对 <code>loader</code> 结束之后，打包的整个过程。它并不直接操作文件，而是基于事件机制工作。在 webpack 构建流程中的特定时机会广播对应的事件，插件可以监听这些事件的发生，在特定的时机做对应的事情。包括：打包优化，资源管理，注入环境变量。</p><h2 id="plugin-该怎么配置呢？" tabindex="-1">plugin 该怎么配置呢？ <a class="header-anchor" href="#plugin-该怎么配置呢？" aria-hidden="true">#</a></h2><p>例如 <code>HtmlWebpackPlugin</code> 可以为我们生成一个 HTML 文件，其中包括使用 <code>script</code> 标签的 body 中的所有模块。看下如何配置：</p><div class="language-js"><pre><code><span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;html-webpack-plugin&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>温馨提示：<code>loader</code> 在 module.rules 中配置，作为模块的解析规则，类型为数组。每一项都是一个对象，内部包含了 test(类型文件)、loader、options(参数)等属性。<code>plugin</code> 则单独配置，类型为数组，每一项是一个 <code>plugin</code> 的实例，参数都通过构造函数传入。</p></blockquote><h2 id="有哪些常见的-plugin？" tabindex="-1">有哪些常见的 plugin？ <a class="header-anchor" href="#有哪些常见的-plugin？" aria-hidden="true">#</a></h2><p>下面整理的插件列表来自 webpack 中文官网，大家看见不熟悉的 <code>plugin</code> 可以点击名称跳转，看一看，了解一下具体玩法。</p><table><thead><tr><th>名称</th><th>描述</th></tr></thead><tbody><tr><td><a href="https://www.webpackjs.com/plugins/aggressive-splitting-plugin/" target="_blank" rel="noopener noreferrer">AggressiveSplittingPlugin</a></td><td>将原来的 chunk 分成更小的 chunk</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/babel-minify-webpack-plugin/" target="_blank" rel="noopener noreferrer">BabelMinifyWebpackPlugin</a></td><td>使用 babel-minify 进行压缩</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/banner-plugin/" target="_blank" rel="noopener noreferrer">BannerPlugin</a></td><td>在每个生成的 chunk 顶部添加 banner</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/commons-chunk-plugin/" target="_blank" rel="noopener noreferrer">CommonsChunkPlugin</a></td><td>提取 chunks 之间共享的通用模块</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/compression-webpack-plugin/" target="_blank" rel="noopener noreferrer">CompressionWebpackPlugin</a></td><td>预先准备的资源压缩版本，使用 Content-Encoding 提供访问服务</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/context-replacement-plugin/" target="_blank" rel="noopener noreferrer">ContextReplacementPlugin</a></td><td>重写 require 表达式的推断上下文</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/copy-webpack-plugin/" target="_blank" rel="noopener noreferrer">CopyWebpackPlugin</a></td><td>将单个文件或整个目录复制到构建目录</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/define-plugin/" target="_blank" rel="noopener noreferrer">DefinePlugin</a></td><td>允许在编译时(compile time)配置的全局常量</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/dll-plugin/" target="_blank" rel="noopener noreferrer">DllPlugin</a></td><td>为了极大减少构建时间，进行 dll 分包</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/environment-plugin" target="_blank" rel="noopener noreferrer">EnvironmentPlugin</a></td><td>DefinePlugin 中 process.<wbr>env 键的简写方式。</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/extract-text-webpack-plugin" target="_blank" rel="noopener noreferrer">ExtractTextWebpackPlugin</a></td><td>从 bundle 中提取文本（CSS）到单独的文件</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/hot-module-replacement-plugin" target="_blank" rel="noopener noreferrer">HotModuleReplacementPlugin</a></td><td>启用模块热替换(Enable Hot Module Replacement - HMR)</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/html-webpack-plugin" target="_blank" rel="noopener noreferrer">HtmlWebpackPlugin</a></td><td>简单创建 HTML 文件，用于服务器访问</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/i18n-webpack-plugin" target="_blank" rel="noopener noreferrer">I18nWebpackPlugin</a></td><td>为 bundle 增加国际化支持</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/ignore-plugin" target="_blank" rel="noopener noreferrer">IgnorePlugin</a></td><td>从 bundle 中排除某些模块</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/limit-chunk-count-plugin" target="_blank" rel="noopener noreferrer">LimitChunkCountPlugin</a></td><td>设置 chunk 的最小/最大限制，以微调和控制 chunk</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/loader-options-plugin" target="_blank" rel="noopener noreferrer">LoaderOptionsPlugin</a></td><td>用于从 webpack 1 迁移到 webpack 2</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/min-chunk-size-plugin" target="_blank" rel="noopener noreferrer">MinChunkSizePlugin</a></td><td>确保 chunk 大小超过指定限制</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/no-emit-on-errors-plugin" target="_blank" rel="noopener noreferrer">NoEmitOnErrorsPlugin</a></td><td>在输出阶段时，遇到编译错误跳过</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/normal-module-replacement-plugin" target="_blank" rel="noopener noreferrer">NormalModuleReplacementPlugin</a></td><td>替换与正则表达式匹配的资源</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/npm-install-webpack-plugin" target="_blank" rel="noopener noreferrer">NpmInstallWebpackPlugin</a></td><td>在开发时自动安装缺少的依赖</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/provide-plugin" target="_blank" rel="noopener noreferrer">ProvidePlugin</a></td><td>不必通过 import/require 使用模块</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/source-map-dev-tool-plugin" target="_blank" rel="noopener noreferrer">SourceMapDevToolPlugin</a></td><td>对 source map 进行更细粒度的控制</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/eval-source-map-dev-tool-plugin" target="_blank" rel="noopener noreferrer">EvalSourceMapDevToolPlugin</a></td><td>对 eval source map 进行更细粒度的控制</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/uglifyjs-webpack-plugin" target="_blank" rel="noopener noreferrer">UglifyjsWebpackPlugin</a></td><td>可以控制项目中 UglifyJS 的版本</td></tr><tr><td><a href="https://www.webpackjs.com/plugins/zopfli-webpack-plugin/" target="_blank" rel="noopener noreferrer">ZopfliWebpackPlugin</a></td><td>通过 node-zopfli 将资源预先压缩的版本</td></tr></tbody></table><h2 id="怎么写一个-plugin？" tabindex="-1">怎么写一个 plugin？ <a class="header-anchor" href="#怎么写一个-plugin？" aria-hidden="true">#</a></h2><p>在说怎么写插件之前，先简单介绍几个好玩的东西：<code>tapable</code>、<code>compiler</code> 和 <code>compilation</code>。</p><h3 id="tapable" tabindex="-1">tapable <a class="header-anchor" href="#tapable" aria-hidden="true">#</a></h3><p><code>tapable</code> 是一个类似于 <code>nodejs</code> 的 <code>EventEmitter</code> 的库, 主要是控制钩子函数的发布与订阅。当然，<code>tapable</code> 提供的 <code>hook</code> 机制比较全面，分为同步和异步两个大类(异步中又区分异步并行和异步串行)，而根据事件执行的终止条件的不同，由衍生出 <code>Bail</code> / <code>Waterfall</code> / <code>Loop</code> 类型。</p><p>基本使用：</p><div class="language-js"><pre><code><span class="token keyword">const</span> <span class="token punctuation">{</span> SyncHook <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;hi&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hi </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">&quot;july&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// hello july</span>
<span class="token comment">// hi july</span>
</code></pre></div><p>小结：</p><p><code>tapable</code> 基本逻辑是，先通过类实例的 <code>tap</code> 方法注册对应 <code>hook</code> 的处理函数，然后通过 <code>call</code> 方法触发回调函数。</p><h3 id="compiler" tabindex="-1">compiler <a class="header-anchor" href="#compiler" aria-hidden="true">#</a></h3><p><code>compiler</code> 对象包含 webpack 环境所有配置信息，包含 options、loaders 和 plugins 等信息。可以简单理解为 webpack 实例。<strong>代表整个 webpack 从启动到关闭的生命周期</strong>。</p><p><code>compile</code> 的内部实现：</p><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">Compiler</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">/** @type {SyncBailHook&lt;Compilation&gt;} */</span>
      <span class="token literal-property property">shouldEmit</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncBailHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;compilation&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncSeriesHook&lt;Stats&gt;} */</span>
      <span class="token literal-property property">done</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;stats&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncSeriesHook&lt;&gt;} */</span>
      <span class="token literal-property property">additionalPass</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">AsyncSeriesHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {AsyncSeriesHook&lt;Compiler&gt;} */</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>小结：</p><p><code>compile</code> 继承了 <code>tapable</code> ，然后在实例上绑定了一个 <code>hook</code> 对象。</p><h3 id="compilation" tabindex="-1">compilation <a class="header-anchor" href="#compilation" aria-hidden="true">#</a></h3><p><code>compilation</code> 对象包含了当前的模块资源、编译生成资源和变化的文件等。<strong>仅代表一次新的编译</strong>。</p><p><code>compilation</code> 的实现：</p><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">Compilation</span> <span class="token keyword">extends</span> <span class="token class-name">Tapable</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * Creates an instance of Compilation.
   * @param {Compiler} compiler the compiler which created the compilation
   */</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>hooks <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token comment">/** @type {SyncHook&lt;Module&gt;} */</span>
      <span class="token literal-property property">buildModule</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {SyncHook&lt;Module&gt;} */</span>
      <span class="token literal-property property">rebuildModule</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {SyncHook&lt;Module, Error&gt;} */</span>
      <span class="token literal-property property">failedModule</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;error&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {SyncHook&lt;Module&gt;} */</span>
      <span class="token literal-property property">succeedModule</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;module&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {SyncHook&lt;Dependency, string&gt;} */</span>
      <span class="token literal-property property">addEntry</span><span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;entry&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">/** @type {SyncHook&lt;Dependency, string, Error&gt;} */</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当运行 webpack 开发环境中间件时，每当检测到一个文件变化，就会创建一个新的 <code>compilation</code>，从而生成一组新的编译资源。一个 <code>compilation</code> 对象表现了当前的模块资源、编译生成资源、变化的文件、以及被跟踪依赖的状态信息。<code>compilation</code> 对象也提供了很多关键时机的回调，以供插件做自定义处理时选择使用。</p><h3 id="热身" tabindex="-1">热身 <a class="header-anchor" href="#热身" aria-hidden="true">#</a></h3><p>写一个最基础的 <code>plugin</code>：</p><div class="language-js"><pre><code><span class="token comment">// 一个 JavaScript 命名函数。</span>
<span class="token keyword">function</span> <span class="token function">SimplePlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 在插件函数的 prototype 上定义一个 `apply` 方法。</span>
<span class="token class-name">SimplePlugin</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">apply</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 指定一个挂载到 webpack 自身的事件钩子。</span>
  compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;webpacksEventHook&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
    compilation <span class="token comment">/* 处理 webpack 内部实例的特定数据。*/</span><span class="token punctuation">,</span>
    callback
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;This is an simple plugin!!!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 功能完成后调用 webpack 提供的回调。</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>webpack 启动后，做了下面几件事情：</p><ul><li>在读取配置的过程中先执行 <code>new SimplePlugin()</code>，初始化一个 SimplePlugin 并获得其实例。</li><li>在初始化 <code>compiler</code> 对象后，再调用 <code>SimplePlugin.apply(compiler)</code> 为插件实例传入 <code>compiler</code> 对象。</li><li>插件实例在获取到 <code>compiler</code> 对象后，就可以通过 <code>compiler.plugin(&quot;webpacksEventHook&quot;, function(compilation, callback){})</code> 监听到 webpack 广播的事件，并且通过 <code>compiler</code> 对象去操作 webpack。</li></ul><h3 id="实战" tabindex="-1">实战 <a class="header-anchor" href="#实战" aria-hidden="true">#</a></h3><p>下面写一个实用的插件。</p><p>作用是在 webpack 马上关闭时做一些事情。例如告知用打包完成，是否执行成功。或者执行一些 <code>script</code> 脚本。我们将其命名为 <code>AfterWebpackPlugin</code> 。用法如下：</p><div class="language-js"><pre><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 分别传入成功和失败时的回调函数</span>
    <span class="token keyword">new</span> <span class="token class-name">AfterWebpackPlugin</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 可以通知用户构建成功，执行发布脚本</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 构建失败时，抛出异常</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里实现过程需要借助以下两个钩子：</p><ul><li><strong>done</strong>：在成功构建并且输出文件后，webpack 马上退出时发生。</li><li><strong>failed</strong>：在构建异常时导致构建失败，webpack 马上退出时发生。</li></ul><p>实现代码如下：</p><div class="language-js"><pre><code><span class="token keyword">class</span> <span class="token class-name">AfterWebpackPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">doneCb<span class="token punctuation">,</span> failedCb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 传入回调函数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>doneCb <span class="token operator">=</span> doneCb<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>failedCb <span class="token operator">=</span> failedCb<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;done&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// webpack 生命周期 `done` 中的回调</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doneCb</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">&quot;failed&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// webpack 生命周期 `failed` 中的回调</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">failedCb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> AfterWebpackPlugin<span class="token punctuation">;</span>
</code></pre></div><p>开发插件小结：</p><ul><li>注意在 webpack 生命周期中找到合适的钩子去完成功能。</li><li>注意理解 webpack 生命周期中各个钩子的细微区别。</li></ul><h2 id="拓展" tabindex="-1">拓展 <a class="header-anchor" href="#拓展" aria-hidden="true">#</a></h2><p>webpack <strong>输出阶段</strong>会发生的事件及解释如下：</p><table><thead><tr><th>事件名</th><th>解释</th></tr></thead><tbody><tr><td>should-emit</td><td>所有需要输出的文件已经生成，询问插件有哪些文件需要输出，有哪些不需要输出</td></tr><tr><td>emit</td><td>确定好要输出哪些文件后，执行文件输出，可以在这里获取和修改输出的内容</td></tr><tr><td>after-emit</td><td>文件输出完毕</td></tr><tr><td>done</td><td>成功完成一次完整的编译和输出流程</td></tr><tr><td>failed</td><td>如果在编译和输出的流程遇到异常，导致 webpack 退出，就会直接跳转到本步骤，插件可以在本事件中获取具体错误原因</td></tr></tbody></table><h2 id="系列文章" tabindex="-1">系列文章 <a class="header-anchor" href="#系列文章" aria-hidden="true">#</a></h2><ul><li><a href="https://juejin.cn/post/6916315177411411981" target="_blank" rel="noopener noreferrer">「webpack 核心特性」loader</a></li><li>「webpack 核心特性」插件(plugin)</li><li><a href="https://juejin.cn/post/6870258201384714253" target="_blank" rel="noopener noreferrer">「webpack 核心特性」模块热替换(HMR)</a></li></ul><h2 id="感谢" tabindex="-1">感谢 <a class="header-anchor" href="#感谢" aria-hidden="true">#</a></h2><ul><li>如果本文对你有帮助 😘，就点个<a href="https://github.com/yanxugong/blog" target="_blank" rel="noopener noreferrer">Star 👍</a> 支持下吧！感谢阅读。</li></ul></div></div><footer class="page-footer" data-v-3d00e640 data-v-0d8328fe><div class="edit" data-v-0d8328fe><div class="edit-link" data-v-0d8328fe data-v-f484245e><a class="link" href="https://github.com/yanxugong/blog-next/edit/main/study/engineering/webpack-plugin.md" target="_blank" rel="noopener noreferrer" data-v-f484245e>为此页提供修改建议 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-f484245e><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-0d8328fe><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about_index.md\":\"c8fb677e\",\"emotion_index.md\":\"9df12840\",\"index.md\":\"122593cd\",\"photography_index.md\":\"8ab54a43\",\"study_algorithm_linked-list.md\":\"56de5a22\",\"study_engineering_vite.md\":\"a5e68948\",\"study_engineering_webpack-hmr.md\":\"fd9d7b24\",\"study_engineering_webpack-loader.md\":\"c44e1d7e\",\"study_engineering_webpack-main.md\":\"c92b7e90\",\"study_engineering_webpack-plugin.md\":\"b64db039\",\"study_frame_deep-react-one.md\":\"9567db07\",\"study_frame_deep-react-two.md\":\"647e3106\",\"study_index.md\":\"24d0e116\",\"study_js-basis_implementation-mechanism.md\":\"5724d96f\",\"study_js-basis_prototype-and-prototype-chain.md\":\"dffe13ab\",\"study_js-basis_scope-and-closure.md\":\"128bae09\",\"study_js-basis_syntax-and-api.md\":\"53be698c\",\"study_js-basis_variables-and-types.md\":\"9fcfaf7a\",\"study_js-basis_you-do-not-konw-js-down.md\":\"96afbde7\",\"study_js-basis_you-do-not-konw-js.md\":\"646fef6b\",\"study_network_from-url-to-page-render.md\":\"ffd09749\",\"study_performance-optimization_first-screen.md\":\"0aa2c624\",\"study_server_go-getting-started.md\":\"ce44aeeb\",\"study_vue3_responsive-system.md\":\"d48489bb\"}")</script>
    <script type="module" async src="/blog-next/assets/app.acdedced.js"></script>
    
  </body>
</html>
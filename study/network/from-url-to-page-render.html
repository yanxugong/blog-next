<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>说一说从 URL 输入到页面呈现到底发生了什么？ | Yanxu Gong's Blog</title>
    <meta name="description" content="Personal blog based on Github Action + VitePress">
    <link rel="stylesheet" href="/assets/style.88a1b92e.css">
    <link rel="modulepreload" href="/assets/chunks/AlgoliaSearchBox.9baa3721.js">
    <link rel="modulepreload" href="/assets/app.c22de5e0.js">
    <link rel="modulepreload" href="/assets/study_network_from-url-to-page-render.md.1fbee58a.lean.js">
    
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <meta name="twitter:title" content="说一说从 URL 输入到页面呈现到底发生了什么？ | Yanxu Gong&#39;s Blog">
  <meta property="og:title" content="说一说从 URL 输入到页面呈现到底发生了什么？ | Yanxu Gong&#39;s Blog">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-95cd145e><div class="sidebar-button" data-v-95cd145e><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="Yanxu Gong&#39;s Blog, back to home" data-v-95cd145e data-v-2627e0f1><img class="logo" src="/logo.svg" alt="Logo" data-v-2627e0f1> Yanxu Gong&#39;s Blog</a><div class="flex-grow" data-v-95cd145e></div><div class="nav" data-v-95cd145e><nav class="nav-links" data-v-95cd145e data-v-b68e4bf6><!--[--><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item active" href="/study/" data-v-43e5dab6>学习 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/photography/" data-v-43e5dab6>摄影 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/emotion/" data-v-43e5dab6>情感 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/about/" data-v-43e5dab6>关于 <!----></a></div></div><!--]--><!----><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item isExternal" href="https://github.com/yanxugong/blog-next" target="_blank" rel="noopener noreferrer" data-v-43e5dab6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-43e5dab6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-1c2cc348><nav class="nav-links nav" data-v-1c2cc348 data-v-b68e4bf6><!--[--><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item active" href="/study/" data-v-43e5dab6>学习 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/photography/" data-v-43e5dab6>摄影 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/emotion/" data-v-43e5dab6>情感 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/about/" data-v-43e5dab6>关于 <!----></a></div></div><!--]--><!----><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item isExternal" href="https://github.com/yanxugong/blog-next" target="_blank" rel="noopener noreferrer" data-v-43e5dab6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-43e5dab6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-1c2cc348><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#前言">前言</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#网络请求">网络请求</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#构建请求">构建请求</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#dns-解析">DNS 解析</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#建立-tcp-连接">建立 TCP 连接</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#发送-http-请求">发送 HTTP 请求</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#网络响应">网络响应</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#浏览器解析渲染页面">浏览器解析渲染页面</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#构建-dom-树">构建 DOM 树</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#样式计算">样式计算</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#生成布局树">生成布局树</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#构建图层树">构建图层树</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#生成绘制列表">生成绘制列表</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#断开连接">断开连接</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#参考文章">参考文章</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#感谢">感谢</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-3d00e640><div class="container" data-v-3d00e640><!--[--><!--]--><div style="position:relative;" class="content" data-v-3d00e640><div><h1 id="说一说从-url-输入到页面呈现到底发生了什么？" tabindex="-1">说一说从 URL 输入到页面呈现到底发生了什么？ <a class="header-anchor" href="#说一说从-url-输入到页面呈现到底发生了什么？" aria-hidden="true">#</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-hidden="true">#</a></h2><p>这是面试过程中一道<strong>高频</strong>考题。</p><p>从面试官的角度思考：</p><ul><li>出现频繁，可能是因为面试官通常喜欢问一些考察<strong>可深可浅</strong>的题目</li><li>很多面试管喜欢根据我们应聘者的考题回答中，甚至我们随口说到的知识点，<strong>继续追问</strong></li></ul><p>基本回答：</p><ul><li>浏览器解析 URL 获取协议，主机，端口， path</li><li>浏览器获取主机 ip 地址</li><li>建立 TCP 连接，然后发送 HTTP 请求</li><li>服务器将响应报文通过 TCP 连接发送回浏览器，浏览器接收 HTTP 响应，根据资源类型决定如何处理（假设资源为 HTML 文档）</li><li>解析 HTML 文档，构件 DOM 树，下载资源，构造 CSSOM 树，执行 js 脚本，最后展现出来给用户</li></ul><p>如果应聘者只回答了上述步骤，很多<strong>关键步骤</strong>（前端应该了解的知识点）没有提及，很有可能达不到面试官想要的回答效果。</p><p>笔者针对一些关键步骤，具体展开说明。让这道题成为我们面试考卷中的<strong>加分项</strong>。</p><h2 id="网络请求" tabindex="-1">网络请求 <a class="header-anchor" href="#网络请求" aria-hidden="true">#</a></h2><h3 id="构建请求" tabindex="-1">构建请求 <a class="header-anchor" href="#构建请求" aria-hidden="true">#</a></h3><p>浏览器会构建请求行：</p><div class="language-"><pre><code>// 请求方法是 GET，路径为根路径，HTTP 协议版本为 1.1
GET / HTTP/1.1
</code></pre></div><p>然后根据 Cache-control 和 Expires 字段，检查强缓存，如果命中直接使用，否则进入下一步。关于强缓存，如果不清楚可以参考下图：</p><p><img src="https://user-gold-cdn.xitu.io/2020/4/27/171b945dfb35de4c?w=1059&amp;h=1162&amp;f=png&amp;s=236754" alt=""></p><h3 id="dns-解析" tabindex="-1">DNS 解析 <a class="header-anchor" href="#dns-解析" aria-hidden="true">#</a></h3><p>由于我们输入的是域名，而数据包是通过 IP 地址传给对方的。因此我们需要得到域名对应的 IP 地址。这个过程需要依赖一个服务系统，这个系统将域名和 IP 一一映射，我们将这个系统就叫做 DNS（域名系统）。</p><p>DNS 协议提供通过域名查找 IP 地址，或逆向从 IP 地址反查域名的服务。得到具体 IP 的过程就是 DNS 解析。</p><p>DNS 是一个网络服务器，我们的域名解析简单来说就是在 DNS 上记录一条信息记录。</p><div class="language-"><pre><code>例如 baidu.com 220.114.23.56（服务器外网IP地址）80（服务器端口号）
</code></pre></div><p>浏览器通过域名去查询 URL 对应的 IP ：</p><ul><li>浏览器缓存：浏览器会按照一定的频率缓存 DNS 记录</li><li>操作系统缓存：如果浏览器缓存中找不到需要的 DNS 记录，那就去操作系统中找</li><li>路由缓存：路由器也有 DNS 缓存</li><li>ISP 的 DNS 服务器：ISP 是互联网服务提供商( Internet Service Provider )的简称，ISP 有专门的 DNS 服务器应对 DNS 查询请求</li><li>根服务器：ISP 的 DNS 服务器还找不到的话，它就会向根服务器发出请求，进行递归查询（DNS 服务器先问根域名服务器 .com 域名服务器的 IP 地址，然后再问 .baidu 域名服务器，依次类推）</li></ul><h3 id="建立-tcp-连接" tabindex="-1">建立 TCP 连接 <a class="header-anchor" href="#建立-tcp-连接" aria-hidden="true">#</a></h3><p><img src="https://user-gold-cdn.xitu.io/2020/4/26/171b6b4eb4726917?w=649&amp;h=416&amp;f=jpeg&amp;s=43567" alt=""></p><p>TCP 三次握手的过程如下：</p><ul><li><strong>客户端发送一个带 SYN=1，Seq=X 的数据包到服务器端口</strong>（第一次握手，由浏览器发起，告诉服务器我要发送请求了）</li><li><strong>服务器发回一个带 SYN=1， ACK=X+1， Seq=Y 的响应包以示传达确认信息</strong>（第二次握手，由服务器发起，告诉浏览器我准备接受了，你赶紧发送吧）</li><li><strong>客户端再回传一个带 ACK=Y+1， Seq=Z 的数据包，代表“握手结束”</strong>（第三次握手，由浏览器发送，告诉服务器，我马上就发了，准备接受吧）</li></ul><p>谢希仁著《计算机网络》中讲“三次握手”的目的是“<strong>为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误</strong>”。</p><h3 id="发送-http-请求" tabindex="-1">发送 HTTP 请求 <a class="header-anchor" href="#发送-http-请求" aria-hidden="true">#</a></h3><p>现在 TCP 连接建立完毕，浏览器可以和服务器开始通信，即开始发送 HTTP 请求。浏览器发 HTTP 请求要携带三样东西：<strong>请求行</strong>、<strong>请求头</strong>和<strong>请求体</strong>。</p><p><img src="https://user-gold-cdn.xitu.io/2020/4/27/171bacc6bdaf0b44?w=759&amp;h=267&amp;f=webp&amp;s=13738" alt=""></p><p>1.<strong>请求行</strong>包含请求方法、URL、协议版本</p><ul><li>请求方法包含 8 种：GET、POST、PUT、DELETE、PATCH、HEAD、OPTIONS、TRACE</li><li>URL 即请求地址，由 &lt;协议&gt;：//&lt;主机&gt;：&lt;端口&gt;/&lt;路径&gt;?&lt;参数&gt; 组成</li><li>协议版本即 http 版本号</li></ul><div class="language-"><pre><code>POST /user.html HTTP/1.1
</code></pre></div><p>2.<strong>请求头</strong>包含请求的附加信息，由关键字/值对组成，如下</p><div class="language-"><pre><code>// 服务器可以接受的文件格式
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
// 指定浏览器可以支持的 Web 服务器返回的内容压缩编码类型
Accept-Encoding: gzip, deflate, br
// 浏览器支持的语言
Accept-Language: zh-CN,zh;q=0.9
// 缓存机制
Cache-Control: no-cache
// 是否需要持久连接
Connection: keep-alive
// 发送该请求域名下所有 Cookie 值到服务器
Cookie: /* 省略cookie信息 */
// 指定请求的服务器的域名和端口号
Host: www.baidu.com
Pragma: no-cache
Upgrade-Insecure-Requests: 1
// 用户代理 UA，包含发出请求的用户信息
User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 11_0 like Mac OS X) AppleWebKit/604.1.38 (KHTML, like Gecko) Version/11.0 Mobile/15A372 Safari/604.1

</code></pre></div><p>3.<strong>请求体</strong>，可以承载多个请求参数的数据，包含回车符、换行符和请求数据，一般在 POST 方法下存在。</p><h2 id="网络响应" tabindex="-1">网络响应 <a class="header-anchor" href="#网络响应" aria-hidden="true">#</a></h2><p>跟请求部分类似，网络响应具有三个部分:<strong>响应行</strong>、<strong>响应头</strong>和<strong>响应体</strong>。</p><p>1.<strong>响应行</strong>包含：协议版本，状态码，状态码描述</p><div class="language-"><pre><code>HTTP/1.1 200 OK
</code></pre></div><p>状态码规则如下：</p><ul><li><p>1xx：指示信息--表示请求已接收，继续处理</p></li><li><p>2xx：成功--表示请求已被成功接收、理解、接受</p></li><li><p>3xx：重定向--要完成请求必须进行更进一步的操作</p></li><li><p>4xx：客户端错误--请求有语法错误或请求无法实现</p></li><li><p>5xx：服务器端错误--服务器未能实现合法的请求</p><p>2.<strong>响应头部</strong>包含响应报文的附加信息，由 名/值 对组成，如下：</p></li></ul><div class="language-"><pre><code>// 缓存机制
Cache-Control: no-cache
Connection: keep-alive
Content-Encoding: gzip
// 表示具体请求中的媒体类型信息，决定浏览器将以什么形式、什么编码读取这个文件
Content-Type: text/html;charset=utf-8
// 原始服务器消息发出的时间
Date: Wed, 04 Dec 2019 12:29:13 GMT
// Web 服务器软件名称
Server: apache
// 由服务器端向客户端发送 cookie
Set-Cookie: rsv_i=f9a0SIItKqzv7kqgAAgphbGyRts3RwTg%2FLyU3Y5Eh5LwyfOOrAsvdezbay0QqkDqFZ0DfQXby4wXKT8Au8O7ZT9UuMsBq2k; path=/; domain=.baidu.com
</code></pre></div><p>这里注意下 Set-Cookie 中关于<strong>网络安全</strong>方面的两个值：HttpOnly、SameSite</p><blockquote><p>设置了 HttpOnly 属性的 cookie 不能使用 JavaScript 经由 Document.cookie 属性、XMLHttpRequest 和 Request APIs 进行访问，以防范跨站脚本攻击（XSS）。</p></blockquote><blockquote><p>SameSite=Lax 允许服务器设定一则 cookie 不随着跨域请求一起发送，这样可以在一定程度上防范跨站请求伪造攻击（CSRF）。</p></blockquote><p>3.<strong>响应主体</strong>包含回车符、换行符和响应返回数据，并不是所有响应报文都有响应数据</p><p>响应完成之后要判断 Connection 字段，如果请求头或响应头中包含 Connection： Keep-Alive ，表示建立了持久连接，这样 TCP 连接会一直保持，之后请求统一站点的资源会复用这个连接。 否则断开 TCP 连接, 请求-响应流程结束。</p><p>总结浏览器端的网络请求过程：</p><p><img src="https://user-gold-cdn.xitu.io/2020/4/27/171bae65706fd126?w=829&amp;h=645&amp;f=jpeg&amp;s=29914" alt=""></p><h2 id="浏览器解析渲染页面" tabindex="-1">浏览器解析渲染页面 <a class="header-anchor" href="#浏览器解析渲染页面" aria-hidden="true">#</a></h2><p><img src="https://user-gold-cdn.xitu.io/2020/4/26/171b5cf50c00398a?w=752&amp;h=258&amp;f=png&amp;s=35640" alt=""></p><p>浏览器解析渲染页面分为以下五个步骤：</p><ul><li>根据 HTML 解析出 DOM 树</li><li>根据 CSS 解析生成 CSS 规则树</li><li>结合 DOM 树和 CSS 规则树，生成渲染树</li><li>根据渲染树计算每一个节点的信息</li><li>根据计算好的信息绘制页面</li></ul><blockquote><p>回流时，以上流程会重新走一遍。重绘时，会重新计算样式，跳过中间步骤直接生成绘制列表。可见，重绘不一定导致回流，但回流一定发生了重绘。</p></blockquote><p><img src="https://user-gold-cdn.xitu.io/2020/4/26/171b6bd66cc4ebf0?w=689&amp;h=241&amp;f=jpeg&amp;s=14937" alt=""></p><h3 id="构建-dom-树" tabindex="-1">构建 DOM 树 <a class="header-anchor" href="#构建-dom-树" aria-hidden="true">#</a></h3><ul><li><p>HTML 语法定义</p><p>HTML 的词汇与句法定义在 w3c 组织创建的规范中。当前版本是 HTML4，HTML5 的工作正在进行中。</p></li><li><p>不是上下文无关语法</p><p>在对解析器的介绍中看到，语法可以用类似 BNF 的格式规范地定义。不幸的是所有常规解析器的讨论都不适用于 HTML （我提及它们并不是为了娱乐，它们可以用于解析 CSS 和 JavaScript ）。HTML 无法用解析器所需的上下文无关的语法来定义。过去 HTML 格式规范由 DTD (Document Type Definition) 来定义，但它不是一个上下文无关语法。</p><p>HTML 与 XML 相当接近。XML 有许多可用的解析器。HTML 还有一个 XML 变种叫 XHTML ，那么它们主要区别在哪里呢？区别在于 HTML 应用更加”宽容”，它容许你漏掉一些开始或结束标签等。它整个是一个“软”句法，不像 XML 那样严格死板。 总的来说这一看似细微的差别造成了两个不同的世界。一方面这使得 HTML 很流行，因为它包容你的错误，使网页作者的生活变得轻松。另一方面，它使编写语法格式变得困难。所以综合来说，HTML 解析并不简单，现成的上下文相关解析器搞不定，XML 解析器也不行。</p></li><li><p>解析算法</p><ul><li>标记化</li><li>建树</li></ul><p>对应的两个过程就是分词和语法分析（参考<a href="https://juejin.im/post/5e99b91f518825738d528492#heading-2" target="_blank" rel="noopener noreferrer">Babel 编译的解析过程</a>）。</p><p>这里举例重点介绍下 <code>HTML5</code> 的<strong>容错机制</strong>：</p><ul><li><p>使用 <code>&lt;/br&gt;</code> 而不是 <code>&lt;br&gt;</code></p><div class="language-"><pre><code>if (t-&gt;isCloseTag(brTag) &amp;&amp; m_document-&gt;inCompatMode()) {
    reportError(MalformedBRError);
    t-&gt;beginTag = true;
}
</code></pre></div><p>全部换为 <code>&lt;br&gt;</code> 的形式。</p></li><li><p>表格离散</p><div class="language-"><pre><code>&lt;table&gt;
    &lt;table&gt;
        &lt;tr&gt;&lt;td&gt;inner table&lt;/td&gt;&lt;/tr&gt;
    &lt;/table&gt;
    &lt;tr&gt;&lt;td&gt;outer table&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
</code></pre></div><p>WebKit 会自动转换为:</p><div class="language-"><pre><code>&lt;table&gt;
    &lt;tr&gt;&lt;td&gt;outer table&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
&lt;table&gt;
    &lt;tr&gt;&lt;td&gt;inner table&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;
</code></pre></div></li><li><p>表单元素嵌套</p><p>这时候直接忽略里面的 <code>form</code> 。</p></li></ul></li></ul><h3 id="样式计算" tabindex="-1">样式计算 <a class="header-anchor" href="#样式计算" aria-hidden="true">#</a></h3><p>CSS 样式来源一般为三种：</p><ul><li>link 标签引用</li><li>style 标签中样式</li><li>元素内嵌 style 属性</li></ul><h5 id="格式化样式表" tabindex="-1">格式化样式表 <a class="header-anchor" href="#格式化样式表" aria-hidden="true">#</a></h5><p>浏览器无法直接识别 CSS 样式文本，这里渲染引擎接收到 CSS 文本之后将其转化为一个结构话的对象，即 styleSheets 。</p><p>可以在浏览器控制台输入 <code>document.styleSheets</code> 来查看这个最终结构（包含上述三种 CSS 来源）。</p><h5 id="标准化样式属性" tabindex="-1">标准化样式属性 <a class="header-anchor" href="#标准化样式属性" aria-hidden="true">#</a></h5><p>有一些渲染引擎不容易直接理解的 CSS 样式数值，需要在计算样式之前将它们标准化。如：<code>em</code> -&gt; <code>px</code>，<code>red</code> -&gt; <code>#ff0000</code>，<code>bold</code> -&gt; <code>700</code> 等等。</p><h5 id="计算每个节点的具体样式" tabindex="-1">计算每个节点的具体样式 <a class="header-anchor" href="#计算每个节点的具体样式" aria-hidden="true">#</a></h5><p>计算具体样式主要遵循两个规则：<strong>继承</strong>和<strong>层叠</strong></p><ul><li><p>继承：</p><p>每个子节点都会默认继承父节点的样式属性，如果父节点中没有找到，就采用浏览器默认样式，也叫 <code>UserAgent样式</code>。</p></li><li><p>层叠： CSS 的层叠性体现在，最终的样式取决与各个属性共同作用的结果。</p></li></ul><p>计算完样式之后，所有样式值会被挂载到 <code>window.getComputedStyle</code> 中，也就是可以通过 JS 获取计算后的样式。</p><h3 id="生成布局树" tabindex="-1">生成布局树 <a class="header-anchor" href="#生成布局树" aria-hidden="true">#</a></h3><p>布局树生成主要分两部：</p><ul><li>遍历生成的 DOM 树节点，并把它们添加到布局树中</li><li>计算布局树节点的坐标位置</li></ul><blockquote><p>布局树只包含可见元素，对于 head 标签和设置了 display: none 的元素将不会被放入其中。</p></blockquote><p>如果想了解布局的细节，可以读一读人人 FED 团队的文章<a href="https://www.rrfed.com/2017/02/26/chrome-layout/" target="_blank" rel="noopener noreferrer">从 Chrome 源码看浏览器如何 layout 布局</a>。</p><h3 id="构建图层树" tabindex="-1">构建图层树 <a class="header-anchor" href="#构建图层树" aria-hidden="true">#</a></h3><p>这里分两种情况，一种是<strong>显式合成</strong>，一种是<strong>隐式合成</strong>。</p><h5 id="显式合成" tabindex="-1">显式合成 <a class="header-anchor" href="#显式合成" aria-hidden="true">#</a></h5><p>一、拥有<strong>层叠上下文</strong>的节点</p><p>层叠上下文也基本上是有一些特定的 CSS 属性创建的，一般有以下情况：</p><ol><li><p>HTML 根元素本身就具有层叠上下文</p></li><li><p>普通元素设置 position 不为 static 并且设置了 z-index 属性，会产生层叠上下文</p></li><li><p>元素的 opacity 值不是 1</p></li><li><p>元素的 transform 值不是 none</p></li><li><p>元素的 filter 值不是 none</p></li><li><p>元素的 isolation 值是 isolate</p></li><li><p>will-change 指定的属性值为上面任意一个</p></li></ol><p>二、需要<strong>剪裁</strong>的地方</p><p>比如一个 div，你只给他设置 100 * 100 像素的大小，而你在里面放了非常多的文字，那么超出的文字部分就需要被剪裁。当然如果出现了滚动条，那么滚动条会被单独提升为一个图层。</p><h5 id="隐式合成" tabindex="-1">隐式合成 <a class="header-anchor" href="#隐式合成" aria-hidden="true">#</a></h5><p>简单说就是层叠等级低的节点被提升为单独的图层之后，那么所有层叠等级比它高的节点都会成为一个单独的图层。</p><p>这个隐式合成其实隐藏着巨大风险，如果在一个大型应用中，当一个 z-index 比较低的元素被提升为单独图层之后，层叠在它上面的元素统统会被提升为单独的图层，可能会增加上千个图层，大大增加内存压力，甚至直接让页面崩溃。这就是<strong>层爆炸</strong>的原理</p><blockquote><p>当需要 repaint 时，只需要 repaint 本身，而不会影响到其他层。</p></blockquote><h3 id="生成绘制列表" tabindex="-1">生成绘制列表 <a class="header-anchor" href="#生成绘制列表" aria-hidden="true">#</a></h3><p>渲染引擎会将图层的绘制拆分成一个个绘制指令，比如先画背景、再描绘边框......然后将这些指令按顺序组合成一个待绘制列表。</p><p>大家可以 <code>F12</code> 打开 Chrome 开发者工具，在设置栏展开 <code>more tools</code> ，然后选择 <code>Layers</code> 面板，就能看到绘制列表了。</p><p>后面就是渲染进程的主线程把绘制列表提交给合成线程。然后合成线程选择视口附近的图块，把它交给<strong>栅格化线程池</strong>生成位图。</p><p>栅格化操作完成后，<strong>合成线程</strong>会生成一个绘制指令 <code>DrawQuad</code>，并发送给浏览器进程。浏览器进程中的 <code>viz 组件</code> 接收到命令，把页面内容绘制到内存，也就是生成了页面。</p><h2 id="断开连接" tabindex="-1">断开连接 <a class="header-anchor" href="#断开连接" aria-hidden="true">#</a></h2><p>当数据传送完毕，需要断开 TCP 连接，此时发起四次挥手。</p><p><img src="https://user-gold-cdn.xitu.io/2020/4/26/171b4b37a6e26aa9?w=679&amp;h=410&amp;f=jpeg&amp;s=56109" alt=""></p><ul><li>发起方往被动方发送报文，Fin、Ack、Seq，表示已经没有数据传输了。并进入 FIN_WAIT_1 状态。（请求报文发送完成）</li><li>被动方发送报文，Ack、Seq，表示同意关闭请求。此时主机发起方进入 FIN_WAIT_2 状态。(请求报文接受完成)</li><li>被动方向发起方发送报文段，Fin、Ack、Seq，请求关闭连接。并进入 LAST_ACK 状态。(响应报文发送完成)</li><li>发起方向被动方发送报文段，Ack、Seq。然后进入等待 TIME_WAIT 状态。被动方收到发起方的报文段以后关闭连接。发起方等待一定时间未收到回复，则正常关闭。(响应报文接受完成）</li></ul><h2 id="参考文章" tabindex="-1">参考文章 <a class="header-anchor" href="#参考文章" aria-hidden="true">#</a></h2><ul><li><a href="https://segmentfault.com/a/1190000017184701" target="_blank" rel="noopener noreferrer">从 URL 输入到页面展现到底发生什么？</a></li><li><a href="https://juejin.im/post/5df5bcea6fb9a016091def69" target="_blank" rel="noopener noreferrer">(1.6w 字)浏览器灵魂之问，请问你能接得住几个？</a></li><li><a href="https://juejin.im/post/5d4cd42a6fb9a06aea618155" target="_blank" rel="noopener noreferrer">大揭秘！“恐怖”的阿里一面，我究竟想问什么</a></li></ul><h2 id="感谢" tabindex="-1">感谢 <a class="header-anchor" href="#感谢" aria-hidden="true">#</a></h2><p>如果本文对你有帮助，就点个 <a href="https://github.com/yanxugong/blog" target="_blank" rel="noopener noreferrer">Star</a> 支持下吧！感谢阅读。</p></div></div><footer class="page-footer" data-v-3d00e640 data-v-0d8328fe><div class="edit" data-v-0d8328fe><div class="edit-link" data-v-0d8328fe data-v-f484245e><a class="link" href="https://github.com/yanxugong/blog-next/edit/main/study/network/from-url-to-page-render.md" target="_blank" rel="noopener noreferrer" data-v-f484245e>为此页提供修改建议 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-f484245e><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-0d8328fe><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about_index.md\":\"2f61e43f\",\"emotion_index.md\":\"b2cf79bf\",\"index.md\":\"5cf2ec20\",\"photography_index.md\":\"b57a87ac\",\"study_algorithm_linked-list.md\":\"d9d561f4\",\"study_engineering_vite.md\":\"24f57105\",\"study_engineering_webpack-hmr.md\":\"3391673a\",\"study_engineering_webpack-loader.md\":\"227bdf8f\",\"study_engineering_webpack-main.md\":\"7122d194\",\"study_engineering_webpack-plugin.md\":\"0adcea3e\",\"study_frame_deep-react-one.md\":\"e6f368cb\",\"study_frame_deep-react-two.md\":\"d6dacd96\",\"study_index.md\":\"3ce5c2db\",\"study_js-basis_implementation-mechanism.md\":\"bc818774\",\"study_js-basis_prototype-and-prototype-chain.md\":\"3346d6ee\",\"study_js-basis_scope-and-closure.md\":\"91c81f63\",\"study_js-basis_syntax-and-api.md\":\"7a97f3b7\",\"study_js-basis_variables-and-types.md\":\"8c5d0291\",\"study_js-basis_you-do-not-konw-js-down.md\":\"7518d929\",\"study_js-basis_you-do-not-konw-js.md\":\"138d06d6\",\"study_network_from-url-to-page-render.md\":\"1fbee58a\",\"study_performance-optimization_first-screen.md\":\"dff10600\",\"study_server_go-getting-started.md\":\"9be0585c\",\"study_vue3_responsive-system.md\":\"2931a322\"}")</script>
    <script type="module" async src="/assets/app.c22de5e0.js"></script>
    
  </body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>「性能优化」首屏时间指标到底如何采集？ | Yanxu Gong's Blog</title>
    <meta name="description" content="Personal blog based on Github Action + VitePress">
    <link rel="stylesheet" href="/blog-next/assets/style.88a1b92e.css">
    <link rel="modulepreload" href="/blog-next/assets/chunks/AlgoliaSearchBox.dd75b3aa.js">
    <link rel="modulepreload" href="/blog-next/assets/app.acdedced.js">
    <link rel="modulepreload" href="/blog-next/assets/study_performance-optimization_first-screen.md.0aa2c624.lean.js">
    
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <meta name="twitter:title" content="「性能优化」首屏时间指标到底如何采集？ | Yanxu Gong&#39;s Blog">
  <meta property="og:title" content="「性能优化」首屏时间指标到底如何采集？ | Yanxu Gong&#39;s Blog">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-95cd145e><div class="sidebar-button" data-v-95cd145e><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/blog-next/" aria-label="Yanxu Gong&#39;s Blog, back to home" data-v-95cd145e data-v-2627e0f1><img class="logo" src="/blog-next/logo.svg" alt="Logo" data-v-2627e0f1> Yanxu Gong&#39;s Blog</a><div class="flex-grow" data-v-95cd145e></div><div class="nav" data-v-95cd145e><nav class="nav-links" data-v-95cd145e data-v-b68e4bf6><!--[--><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item active" href="/blog-next/study/" data-v-43e5dab6>学习 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/photography/" data-v-43e5dab6>摄影 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/emotion/" data-v-43e5dab6>情感 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/about/" data-v-43e5dab6>关于 <!----></a></div></div><!--]--><!----><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item isExternal" href="https://github.com/yanxugong/blog-next" target="_blank" rel="noopener noreferrer" data-v-43e5dab6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-43e5dab6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-1c2cc348><nav class="nav-links nav" data-v-1c2cc348 data-v-b68e4bf6><!--[--><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item active" href="/blog-next/study/" data-v-43e5dab6>学习 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/photography/" data-v-43e5dab6>摄影 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/emotion/" data-v-43e5dab6>情感 <!----></a></div></div><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item" href="/blog-next/about/" data-v-43e5dab6>关于 <!----></a></div></div><!--]--><!----><div class="item" data-v-b68e4bf6><div class="nav-link" data-v-b68e4bf6 data-v-43e5dab6><a class="item isExternal" href="https://github.com/yanxugong/blog-next" target="_blank" rel="noopener noreferrer" data-v-43e5dab6>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-43e5dab6><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-1c2cc348><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="#一、前言">一、前言</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#二、采集方式">二、采集方式</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-1-手动采集">2.1 手动采集</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-2-自动化采集">2.2 自动化采集</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#三、performance">三、Performance</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-1-performance-timing">3.1 Performance.timing</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-2-耗时计算">3.2 耗时计算</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#四、服务端模板类型指标采集">四、服务端模板类型指标采集</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#五、单页面类型指标采集">五、单页面类型指标采集</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-1-初始化监听">5.1 初始化监听</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-2-计算分数">5.2 计算分数</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-3-计算出-fmp">5.3 计算出 FMP</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#六、相关文章">六、相关文章</a><!----></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-3d00e640><div class="container" data-v-3d00e640><!--[--><!--]--><div style="position:relative;" class="content" data-v-3d00e640><div><h1 id="「性能优化」首屏时间指标到底如何采集？" tabindex="-1">「性能优化」首屏时间指标到底如何采集？ <a class="header-anchor" href="#「性能优化」首屏时间指标到底如何采集？" aria-hidden="true">#</a></h1><h2 id="一、前言" tabindex="-1">一、前言 <a class="header-anchor" href="#一、前言" aria-hidden="true">#</a></h2><p>性能优化一方面是我们前端<strong>经常讨论</strong>的<strong>话题</strong>，另一方面也是我们<strong>面试</strong>过程中考察的<strong>重点</strong>。</p><p>那么，如何来定义性能指标呢？</p><p>这篇文章我们主要介绍一下<strong>首屏</strong>时间如何<strong>采集</strong>。</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/359210d4c6b14793a264038cbd8bafff~tplv-k3u1fbpfcp-watermark.image" alt=""></p><h2 id="二、采集方式" tabindex="-1">二、采集方式 <a class="header-anchor" href="#二、采集方式" aria-hidden="true">#</a></h2><h3 id="_2-1-手动采集" tabindex="-1">2.1 手动采集 <a class="header-anchor" href="#_2-1-手动采集" aria-hidden="true">#</a></h3><blockquote><p><strong>FMP</strong>（First Meaningful Paint）是指页面的主要内容出现在屏幕上所需的时间。</p></blockquote><p>一般是通过埋点的方式进行， 比如在页面开始位置打上 <code>FMP.Start()</code>，在首屏结束位置打上 <code>FMP.End()</code>，利用 <code>FMP.End() - FMP.Start()</code> 获取到首屏时间。</p><p>优点：</p><ul><li>兼容性强，可以随情况变动。</li><li>去中心化，各个业务负责自己的埋点代码。</li></ul><p>缺点：</p><ul><li>埋点代码会和业务代码严重耦合</li><li>业务较多时，可能覆盖率不足</li></ul><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b42ba2a1de6449481da6e81d5883f5c~tplv-k3u1fbpfcp-watermark.image" alt=""></p><h3 id="_2-2-自动化采集" tabindex="-1">2.2 自动化采集 <a class="header-anchor" href="#_2-2-自动化采集" aria-hidden="true">#</a></h3><p>引入一段通用的代码来做首屏时间自动化采集，引入过程中，除了必要的配置不需要做其他事情。</p><p>优点：</p><ul><li>独立性强，接入过程更自动化。</li></ul><p>缺点：</p><ul><li>个性化需求无法满足。</li></ul><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3a2cc8dbfed4a80815cd2cb00771c99~tplv-k3u1fbpfcp-watermark.image" alt=""></p><h2 id="三、performance" tabindex="-1">三、Performance <a class="header-anchor" href="#三、performance" aria-hidden="true">#</a></h2><p><code>Performance</code> 接口可以获取到当前页面中与性能相关的信息。可以通过调用只读属性 <code>window.performance</code> 来获取。</p><blockquote><p>感兴趣的同学可以在浏览器控制台试一试。</p></blockquote><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7932c3690f7440cfac373d9c9211e8d8~tplv-k3u1fbpfcp-watermark.image" alt=""></p><h3 id="_3-1-performance-timing" tabindex="-1">3.1 Performance.timing <a class="header-anchor" href="#_3-1-performance-timing" aria-hidden="true">#</a></h3><p><code>PerformanceTiming</code> 接口是为保持向后兼容性而保留的传统接口，提供了在加载和使用当前页面期间发生的各种事件的<strong>性能计时信息</strong>。通过 <code>window.performance.timing</code> 获取。</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c0fd1db7d474675808604c4c4673662~tplv-k3u1fbpfcp-watermark.image" alt=""></p><p>各个时间戳和页面加载时间节点的对应关系如下图：</p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f959adfae395414385ccd3ad9a422452~tplv-k3u1fbpfcp-watermark.image" alt=""></p><h3 id="_3-2-耗时计算" tabindex="-1">3.2 耗时计算 <a class="header-anchor" href="#_3-2-耗时计算" aria-hidden="true">#</a></h3><ul><li>DNS 查询耗时：<code>domainLookupEnd - domainLookupStart</code></li><li>TCP 连接耗时：<code>connectEnd - connectStart</code></li><li>内容加载耗时：<code>responseEnd - requestStart</code></li><li>firstbyte（首包时间）：<code>responseStart – domainLookupStart</code></li><li>fpt（First Paint Time 首次渲染时间 / 白屏时间）：<code>responseEnd – fetchStart</code></li><li>tti（Time to Interact 首次可交互时间）：<code>domInteractive – fetchStart</code></li><li>ready（HTML 加载完成时间）：<code>domContentLoaded – fetchStart</code></li><li>load（页面完全加载时间）：<code>loadEventStart – fetchStart</code></li></ul><h2 id="四、服务端模板类型指标采集" tabindex="-1">四、服务端模板类型指标采集 <a class="header-anchor" href="#四、服务端模板类型指标采集" aria-hidden="true">#</a></h2><p>服务端模板类型主要指 <code>SSR</code>。</p><p>加载流程如下：</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6db40d4910a449ba9b9c7ba50be50ac0~tplv-k3u1fbpfcp-watermark.image" alt=""></p><p>当 <code>HTML</code> 文档加载解析完成的时候，就是首屏加载完成的时候。首屏时间可以参考浏览器开发者工具 <code>Network</code> 面板的 <code>DOMContentLoaded</code> 值。</p><p>以<strong>掘金</strong>首页为例，这里获取的清缓存加载的 <code>DOMContentLoaded</code> 值为 <code>1.17s</code>，也就是说首屏时间是 <code>1.17s</code>，如下图：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d9f59f877fc4c37a006f57a1c28ef5c~tplv-k3u1fbpfcp-watermark.image" alt=""></p><blockquote><p><code>domContentLoadedEventEnd</code> 指 HTML 文档加载完成时间。<code>fetchStart</code> 指页面初始进入的时间。</p></blockquote><p>这个 <code>1.17s</code> 怎么来的呢？其实就是前面【三、Performance】-&gt;【3.2 耗时计算】章节我们说过的 ready（HTML 加载完成时间）：<code>domContentLoaded – fetchStart</code>。</p><p>我们可以现场验算一下，如下图：</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/367ffb2e71e645f383c84d9d02c9b732~tplv-k3u1fbpfcp-watermark.image" alt=""></p><h2 id="五、单页面类型指标采集" tabindex="-1">五、单页面类型指标采集 <a class="header-anchor" href="#五、单页面类型指标采集" aria-hidden="true">#</a></h2><p>单页面的首屏时间和 SSR 的首屏时间有什么不同吗？</p><p>随着 Vue 和 React 等前端框架盛行，Performance 已无法准确的监控到页面的首屏时间。因为 <code>DOMContentLoaded</code> 的值只能表示<strong>空白页</strong>（当前页面 body 标签里面没有内容）加载花费的时间。浏览器需要先加载 JS , 然后再通过 JS 来渲染页面内容，这个时候<strong>单页面类型</strong>首屏才算渲染完成。</p><p>那我们使用什么数据来当做首屏时间呢？</p><p>如果在首屏渲染过程中，记录各个资源的加载时间，那么最后某个资源加载完的时间是不是就是首屏时间呢？<code>MutationObserver</code> 就可以做这件事情。</p><blockquote><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver</a> 接口提供了监视对 DOM 树所做更改的能力。它被设计为旧的 Mutation Events 功能的替代品，该功能是 DOM3 Events 规范的一部分。</p></blockquote><h3 id="_5-1-初始化监听" tabindex="-1">5.1 初始化监听 <a class="header-anchor" href="#_5-1-初始化监听" aria-hidden="true">#</a></h3><div class="language-js"><pre><code><span class="token function">initObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supportTiming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">;</span>
        <span class="token keyword">let</span> bodyTarget <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          score <span class="token operator">+=</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span>bodyTarget<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            score<span class="token punctuation">,</span>
            <span class="token literal-property property">t</span><span class="token operator">:</span> time
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token literal-property property">score</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token literal-property property">t</span><span class="token operator">:</span> time
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">childList</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token literal-property property">subtree</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">&#39;readyState&#39;</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">&#39;load&#39;</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">&#39;beforeunload&#39;</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">listenTouchstart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          that<span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">&#39;touch&#39;</span><span class="token punctuation">;</span>
          window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">&#39;touchstart&#39;</span><span class="token punctuation">,</span> listenTouchstart<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&#39;touchstart&#39;</span><span class="token punctuation">,</span>
        listenTouchstart<span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们通过 <code>MutationObserver</code> 来监听 Dom 的变化, 然后计算当前时刻 Dom 的分数。</p><h3 id="_5-2-计算分数" tabindex="-1">5.2 计算分数 <a class="header-anchor" href="#_5-2-计算分数" aria-hidden="true">#</a></h3><div class="language-js"><pre><code><span class="token keyword">function</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> tiers<span class="token punctuation">,</span> parentScore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tagName <span class="token operator">=</span> el<span class="token punctuation">.</span>tagName<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token string">&quot;SCRIPT&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;STYLE&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;META&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;HEAD&quot;</span> <span class="token operator">!==</span> tagName
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childrenLen <span class="token operator">=</span> el<span class="token punctuation">.</span>children <span class="token operator">?</span> el<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> childs <span class="token operator">=</span> el<span class="token punctuation">.</span>children<span class="token punctuation">,</span> len <span class="token operator">=</span> childrenLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> len <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          score <span class="token operator">+=</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span>childs<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">,</span> tiers <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> score <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parentScore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>getBoundingClientRect <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top <span class="token operator">&lt;</span> <span class="token constant">WH</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      score <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> tiers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> score<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>计算分数主要做这几件事情：</p><ul><li>从 body 元素开始递归计算。</li><li>排查无用的元素标签。</li><li>如果元素超出屏幕就认为是 0 分。</li><li>第一层的元素是 1 分，第二次的元素是 1 + (层数 * 0.5)，也就是 1.5 分，依次类推，最终得打整个 Dom 数的总体分数。</li></ul><h3 id="_5-3-计算出-fmp" tabindex="-1">5.3 计算出 FMP <a class="header-anchor" href="#_5-3-计算出-fmp" aria-hidden="true">#</a></h3><p>我们通过 <code>MutationObserver</code> 得到了一个数组，数组的每一项就是每次 Dom 变化的时间和分数。</p><div class="language-js"><pre><code><span class="token keyword">let</span> fmps <span class="token operator">=</span> <span class="token function">getFmp</span><span class="token punctuation">(</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> o <span class="token operator">&lt;</span> fmps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t <span class="token operator">&gt;=</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> l <span class="token operator">=</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>score <span class="token operator">-</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>score<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>record <span class="token operator">||</span> record<span class="token punctuation">.</span>rate <span class="token operator">&lt;=</span> l<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>record <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">t</span><span class="token operator">:</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">,</span>
        <span class="token literal-property property">rate</span><span class="token operator">:</span> l<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码，我们会得到最终的 <code>FMP</code> 的值，就是变化最大的这个 DOM 变化。此时 <code>FMP</code> 值就是 <code>SPA</code> 项目的首屏时间。</p><h2 id="六、相关文章" tabindex="-1">六、相关文章 <a class="header-anchor" href="#六、相关文章" aria-hidden="true">#</a></h2><ul><li><a href="http://www.alloyteam.com/2020/01/14184/" target="_blank" rel="noopener noreferrer">如何进行 web 性能监控?</a></li><li><a href="https://www.infoq.cn/article/Dxa8aM44oz*Lukk5Ufhy" target="_blank" rel="noopener noreferrer">蚂蚁金服如何把前端性能监控做到极致?</a></li><li><a href="https://zhuanlan.zhihu.com/p/350657764" target="_blank" rel="noopener noreferrer">统计页面首屏时间，很多人第一步就错了</a></li></ul></div></div><footer class="page-footer" data-v-3d00e640 data-v-0d8328fe><div class="edit" data-v-0d8328fe><div class="edit-link" data-v-0d8328fe data-v-f484245e><a class="link" href="https://github.com/yanxugong/blog-next/edit/main/study/performance-optimization/first-screen.md" target="_blank" rel="noopener noreferrer" data-v-f484245e>为此页提供修改建议 <svg class="icon outbound icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-f484245e><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div><div class="updated" data-v-0d8328fe><!----></div></footer><!----><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about_index.md\":\"c8fb677e\",\"emotion_index.md\":\"9df12840\",\"index.md\":\"122593cd\",\"photography_index.md\":\"8ab54a43\",\"study_algorithm_linked-list.md\":\"56de5a22\",\"study_engineering_vite.md\":\"a5e68948\",\"study_engineering_webpack-hmr.md\":\"fd9d7b24\",\"study_engineering_webpack-loader.md\":\"c44e1d7e\",\"study_engineering_webpack-main.md\":\"c92b7e90\",\"study_engineering_webpack-plugin.md\":\"b64db039\",\"study_frame_deep-react-one.md\":\"9567db07\",\"study_frame_deep-react-two.md\":\"647e3106\",\"study_index.md\":\"24d0e116\",\"study_js-basis_implementation-mechanism.md\":\"5724d96f\",\"study_js-basis_prototype-and-prototype-chain.md\":\"dffe13ab\",\"study_js-basis_scope-and-closure.md\":\"128bae09\",\"study_js-basis_syntax-and-api.md\":\"53be698c\",\"study_js-basis_variables-and-types.md\":\"9fcfaf7a\",\"study_js-basis_you-do-not-konw-js-down.md\":\"96afbde7\",\"study_js-basis_you-do-not-konw-js.md\":\"646fef6b\",\"study_network_from-url-to-page-render.md\":\"ffd09749\",\"study_performance-optimization_first-screen.md\":\"0aa2c624\",\"study_server_go-getting-started.md\":\"ce44aeeb\",\"study_vue3_responsive-system.md\":\"d48489bb\"}")</script>
    <script type="module" async src="/blog-next/assets/app.acdedced.js"></script>
    
  </body>
</html>